<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ğŸŒ å¤šäººæ™ºæ…§æ—…éŠèŠå¤©å®¤</title>
  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; padding: 20px; }
    #chatbox { background: #fff; padding: 20px; max-width: 600px; margin: 0 auto; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    #messages { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
    #messages li { margin: 8px 10px; padding: 5px 10px; }
    .user { color: #2c3e50; }
    .ai { color: #0077cc; font-weight: bold; }
    .system { color: gray; font-style: italic; }
    input[type="text"] { width: 70%; padding: 8px; }
    button { padding: 8px 12px; }
  </style>
</head>
<body>
  <div id="chatbox">
    <h2>ğŸŒ å¤šäººæ™ºæ…§æ—…éŠèŠå¤©å®¤</h2>
    <label>ä½¿ç”¨è€…åç¨±ï¼š</label>
    <input id="user_id" placeholder="è¼¸å…¥ä½ çš„åç¨±">
    <button onclick="connect()">é€£ç·š</button>
    <br><br>

    <ul id="messages"></ul>

    <input id="message" placeholder="è¼¸å…¥è¨Šæ¯..." autocomplete="off" onkeydown="if(event.key==='Enter') sendMessage()">
    <button onclick="sendMessage()">é€å‡º</button>
    <button onclick="sendAnalysis()">ğŸ§  åˆ†æåå¥½</button>
  </div>

  <script>
    let socket;

    const params = new URLSearchParams(window.location.search);
    const userIdFromURL = params.get("user_id");
    if (userIdFromURL) {
      document.getElementById("user_id").value = userIdFromURL;
      document.getElementById("user_id").disabled = true;
      connect();  // è‡ªå‹•é€£ç·š
    }

    function connect() {
      const user_id = document.getElementById("user_id").value.trim();
      if (!user_id) return alert("è«‹è¼¸å…¥ä½¿ç”¨è€…åç¨±");

      socket = io(); // èˆ‡ä¼ºæœå™¨å»ºç«‹é€£ç·š

      socket.on("connect", () => {
        socket.send(user_id);  // å‚³é€ user_id çµ¦å¾Œç«¯
      });

      socket.on("chat_message", function(data) {
        const li = document.createElement("li");
        li.innerHTML = `<span class="user">${data.user_id}ï¼š</span> ${data.message}`;
        document.getElementById("messages").appendChild(li);
        scrollToBottom();
      });

      socket.on("ai_response", function(data) {
        const li = document.createElement("li");
        li.innerHTML = `<span class="ai">ğŸ¤– AIï¼š</span><br>${data.message}`;
        document.getElementById("messages").appendChild(li);
        scrollToBottom();
      });
    }

    function sendMessage() {
      const message = document.getElementById("message").value.trim();
      const user_id = document.getElementById("user_id").value.trim();
      if (!socket || !user_id || !message) return;

      socket.emit("user_message", { user_id, message });
      document.getElementById("message").value = "";
    }

    function sendAnalysis() {
      const user_id = document.getElementById("user_id").value.trim();
      if (!socket || !user_id) return;
      socket.emit("user_message", { user_id, message: "åˆ†æ" });
    }

    function scrollToBottom() {
      const messages = document.getElementById("messages");
      messages.scrollTop = messages.scrollHeight;
    }
  </script>
</body>
</html>
